<html>

	<head>

		<title>chat</title>
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<style>
			ul#messages { list-style: none; }
			ul#messages li { margin-bottom: 2pt; }
			ul#messages li img { margin-right: 10px; }
		</style>

	</head>

	<body>

		<div class="container">
			<div class="panel panel-default">
				<!-- <div class="panel-header">
					chat application using WebSocket
				</div> -->
				<div class="panel-body">
					<ul id="messages"></ul>
				</div>
			</div>
			<form id="chatbox" role="form">
				<div class="form-group">
					<label for="message">{{.UserData.name}}:</label>
					<a href="/logout">sign out</a>
					<textarea id="messabe" class="form-control"></textarea>
					<input type="submit" value="submit" />
				</div>
			</form>
		</div>

		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

		<script>
			$(function(){
				var socket = null;
				var msgBox = $("#chatbox textarea");
				var messages = $("#messages");
				$("#chatbox").submit(function(){
					if (!msgBox.val()) return false;
					if (!socket) {
						alert("ERROR: WebSocket protocol is not used.");
						return false;
					}
					socket.send(JSON.stringify({"Message": msgBox.val()}));
					msgBox.val("");
					return false;
				});
				if (!window["WebSocket"]) {
					alert("ERROR: This browser is not support WebSocket");
				} else {
					socket = new WebSocket("ws://{{.Host}}/room");
					alert("start websocket")
					socket.onclose = function() {
						alert("Connection finished");
					}
					socket.onmessage = function (e) {
						var msg = eval("(" + e.data + ")");
						console.log("avatarURL: ", msg.AvatarURL)
						messages.append(
							$("<li>").append(
								$("<img>").attr("title", msg.Name).css({
									width: 30,
									varticalAlign: "middle"
								}).attr("src", msg.AvatarURL),
								// $("<span>").text(msg.When + ": "),
								$("<span>").text(msg.Message)
							)
						);
					}
				}
			});
		</script>

	</body>

</html>
